<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>enumerate (batch)</title>
<link rel="stylesheet" href="../../../../myboostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="../../../../index.html" title="Chapter&#160;1.&#160;Boost.AFIO 1.1">
<link rel="up" href="../async_file_io_dispatcher_base.html" title="async_file_io_dispatcher_base">
<link rel="prev" href="barrier.html" title="barrier (batch)">
<link rel="next" href="enumerate_1_single.html" title="enumerate (single)">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../../boost.png"></td>
<td align="center"><a href="../../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="barrier.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io_dispatcher_base.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="enumerate_1_single.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h5 class="title">
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch"></a><a class="link" href="enumerate_1_batch.html" title="enumerate (batch)">enumerate
          (batch)</a>
</h5></div></div></div>
<p>
            <a class="indexterm" name="id965910"></a>
Schedule a batch of asynchronous directory enumerations after a preceding
            operations.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h0"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.description"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.description">Description</a>
          </h6>
<p>
            By default dir() returns shared handles i.e. dir("foo") and
            dir("foo") will return the exact same handle, and therefore
            enumerating not all of the entries at once is a race condition. The solution
            is to either set maxitems to a value large enough to guarantee a directory
            will be enumerated in a single shot, or to open a separate directory
            handle using the file_flags::UniqueDirectoryHandle flag.
          </p>
<p>
            Note that setting maxitems=1 will often cause a buffer space exhaustion,
            causing a second syscall with an enlarged buffer. This is because AFIO
            cannot know if the allocated buffer can hold all of the filename being
            retrieved, so it may have to retry. Put another way, setting maxitems=1
            will give you the worst performance possible.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h1"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.synopsis"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.synopsis">Synopsis</a>
          </h6>
<pre class="programlisting"><span class="keyword">virtual</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">directory_entry</span><span class="special">&gt;,</span> <span class="keyword">bool</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="special">&gt;,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">async_io_op</span><span class="special">&gt;</span> <span class="special">&gt;</span> <span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">enumerate</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span> <span class="identifier">async_enumerate_op_req</span> <span class="special">&gt;</span> <span class="special">&amp;</span> <span class="identifier">reqs</span><span class="special">)</span></pre>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h2"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.parameters"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.parameters">Parameters</a>
          </h6>
<div class="informaltable"><table class="table">
<colgroup>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                    <p>
                      Type
                    </p>
                  </th>
<th>
                    <p>
                      Concept
                    </p>
                  </th>
<th>
                    <p>
                      Name
                    </p>
                  </th>
<th>
                    <p>
                      Description
                    </p>
                  </th>
</tr></thead>
<tbody><tr>
<td>
                    <p>
                      const std::vector&lt; async_enumerate_op_req &gt; &amp;
                    </p>
                  </td>
<td>
                  </td>
<td>
                    <p>
                      reqs
                    </p>
                  </td>
<td>
                    <p>
                      A batch of enumeration requests.
                    </p>
                  </td>
</tr></tbody>
</table></div>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h3"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.returns"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.returns">Returns</a>
          </h6>
<p>
            A batch of future vectors of directory entries with boolean returning
            false if done.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h4"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.header"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.header">Header</a>
          </h6>
<p>
            <code class="computeroutput"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">afio</span><span class="special">/</span><span class="identifier">afio</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span></code>
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h5"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.complexity"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.complexity">Complexity</a>
          </h6>
<p>
            Amortised O(N) to dispatch. Amortised O(N/threadpool*M) to complete where
            M is the average number of entries in each directory.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h6"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.exception_model"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.exception_model">Exception
            Model</a>
          </h6>
<p>
            Propagates exceptions of any input preconditions with an errored state
            at the point of dispatch, and throws a <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">runtime_error</span></code>
            if any inputs have values which could not possibly be correct. Once a
            batch of input ops has been verified at the point of entry as not errored,
            you are guaranteed that the batch is atomically scheduled as a whole,
            unless a failure to allocate memory occurs.
          </p>
<h6>
<a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.h7"></a>
            <span class="phrase"><a name="afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.example"></a></span><a class="link" href="enumerate_1_batch.html#afio.reference.classes.async_file_io_dispatcher_base.enumerate_1_batch.example">Example</a>
          </h6>
<pre class="programlisting"><span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">&gt;</span> <span class="identifier">dispatcher</span><span class="special">=</span>
    <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">make_async_file_io_dispatcher</span><span class="special">();</span>

<span class="comment">// Schedule an opening of the root directory</span>
<span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">async_io_op</span> <span class="identifier">rootdir</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">dir</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">"/"</span><span class="special">)));</span>

<span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">directory_entry</span><span class="special">&gt;,</span> <span class="keyword">bool</span><span class="special">&gt;</span> <span class="identifier">list</span><span class="special">;</span>
<span class="comment">// This is used to reset the enumeration to the start</span>
<span class="keyword">bool</span> <span class="identifier">restart</span><span class="special">=</span><span class="keyword">true</span><span class="special">;</span>
<span class="keyword">do</span>
<span class="special">{</span>
    <span class="comment">// Schedule an enumeration of an open directory handle</span>
    <span class="comment">// Note it returns a future to the results and an op ref </span>
    <span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">directory_entry</span><span class="special">&gt;,</span> <span class="keyword">bool</span><span class="special">&gt;&gt;,</span>
        <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">async_io_op</span>
    <span class="special">&gt;</span>  <span class="identifier">enumeration</span><span class="special">(</span>
        <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">enumerate</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">async_enumerate_op_req</span><span class="special">(</span>
            <span class="comment">/* This is the handle to enumerate */</span>
            <span class="identifier">rootdir</span><span class="special">,</span>
            <span class="comment">/* This is the maximum entries to enumerate. Note
            the use of compatibility_maximum() which is the
            same value your libc uses. The problem with smaller
            enumerations is that the directory contents can change
            out from underneath you more frequently. */</span>
            <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">directory_entry</span><span class="special">::</span><span class="identifier">compatibility_maximum</span><span class="special">(),</span>
            <span class="comment">/* True if to reset enumeration */</span>
            <span class="identifier">restart</span><span class="special">)));</span>
    <span class="identifier">restart</span><span class="special">=</span><span class="keyword">false</span><span class="special">;</span>

    <span class="comment">// People using AFIO often forget that futures can be waited</span>
    <span class="comment">// on normally without needing to wait on the op handle</span>
    <span class="identifier">list</span><span class="special">=</span><span class="identifier">enumeration</span><span class="special">.</span><span class="identifier">first</span><span class="special">.</span><span class="identifier">get</span><span class="special">();</span>
    <span class="keyword">for</span><span class="special">(</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">::</span><span class="identifier">directory_entry</span> <span class="special">&amp;</span><span class="identifier">i</span> <span class="special">:</span> <span class="identifier">list</span><span class="special">.</span><span class="identifier">first</span><span class="special">)</span>
    <span class="special">{</span>
        <span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span><span class="special">.</span><span class="identifier">name</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" type "</span> <span class="special">&lt;&lt;</span> <span class="identifier">i</span><span class="special">.</span><span class="identifier">st_type</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
    <span class="special">}</span>
<span class="special">}</span> <span class="keyword">while</span><span class="special">(</span><span class="identifier">list</span><span class="special">.</span><span class="identifier">second</span><span class="special">);</span>
</pre>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013 Niall Douglas and Paul Kirth<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="barrier.html"><img src="../../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io_dispatcher_base.html"><img src="../../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../../index.html"><img src="../../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="enumerate_1_single.html"><img src="../../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
