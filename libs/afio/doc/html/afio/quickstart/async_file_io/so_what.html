<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>What benefit does asynchronous file i/o bring me?</title>
<link rel="stylesheet" href="../../../myboostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.78.1">
<link rel="home" href="../../../index.html" title="Chapter&#160;1.&#160;Boost.AFIO 0.1">
<link rel="up" href="../async_file_io.html" title="Asynchronous file i/o">
<link rel="prev" href="hello_world.html" title="Hello World, asynchronously!">
<link rel="next" href="../closure_engine.html" title="Closure Execution Engines">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<table cellpadding="2" width="100%"><tr>
<td valign="top"><img alt="Boost C++ Libraries" width="277" height="86" src="../../../../../boost.png"></td>
<td align="center"><a href="../../../../../index.html">Home</a></td>
<td align="center"><a href="../../../../../libs/libraries.htm">Libraries</a></td>
<td align="center"><a href="http://www.boost.org/users/people.html">People</a></td>
<td align="center"><a href="http://www.boost.org/users/faq.html">FAQ</a></td>
<td align="center"><a href="../../../../../more/index.htm">More</a></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="hello_world.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="../closure_engine.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="afio.quickstart.async_file_io.so_what"></a><a class="link" href="so_what.html" title="What benefit does asynchronous file i/o bring me?">What benefit
        does asynchronous file i/o bring me?</a>
</h4></div></div></div>
<p>
          So we can schedule file i/o operations asynchronously: what's the benefit
          of doing that instead of creating separate threads of execution and executing
          the file i/o there instead?
        </p>
<p>
          There are three main benefits to using AFIO over doing it by hand:
        </p>
<div class="orderedlist"><ol class="orderedlist" type="1">
<li class="listitem">
              You don't have to worry about threading or race conditions or losing
              error state (as much). AFIO does all that for you.
            </li>
<li class="listitem">
              On platforms which provide native asynchronous file i/o support and/or
              native scatter/gather file i/o support, AFIO will use that instead
              of issuing multiple filing system operations using a thread pool to
              achieve concurrency. This can very significantly reduce the number
              of threads needed to keep your storage device fully occupied -- remember
              that <span class="emphasis"><em>queue depth</em></span> i.e. that metric you see all
              over storage device benchmarks is the number of operations in flight
              at once, which implies the number of threads needed. Most storage devices
              are IOPS limited due to SATA or SAS connection latencies without introducing
              queue depth -- in particular, modern SSDs cannot achieve tens of thousands
              of IOPS range without substantial queue depths, which without using
              a native asynchronous file i/o API means lots of threads.
            </li>
<li class="listitem">
              It's very, very easy to have AFIO turn off file system caching, readahead
              or buffering on a case by case basis which makes writing scalable random
              synchronous file i/o applications much easier.
            </li>
</ol></div>
<p>
          What these three items mean is that writing scalable high-performance filing
          system code is much easier. Let us take a simple example, this being a
          simple STL iostreams, Boost Filesystem and OpenMP based find regular expression
          in files implementation:
        </p>
<pre class="programlisting"><span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span><span class="identifier">argv</span><span class="special">[])</span>
<span class="special">{</span>
	<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">std</span><span class="special">;</span>
	<span class="keyword">using</span> <span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">ifstream</span><span class="special">;</span>
	<span class="keyword">typedef</span> <span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="identifier">ratio</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;&gt;</span> <span class="identifier">secs_type</span><span class="special">;</span>
	<span class="keyword">if</span><span class="special">(</span><span class="identifier">argc</span><span class="special">&lt;</span><span class="number">2</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: Specify a regular expression to search all files in the current directory."</span> <span class="special">&lt;&lt;</span> <span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="comment">// Prime SpeedStep</span>
    <span class="keyword">auto</span> <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
    <span class="keyword">while</span><span class="special">(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">()-</span><span class="identifier">begin</span><span class="special">).</span><span class="identifier">count</span><span class="special">()&lt;</span><span class="number">1</span><span class="special">);</span>
	<span class="identifier">size_t</span> <span class="identifier">bytesread</span><span class="special">=</span><span class="number">0</span><span class="special">,</span> <span class="identifier">filesread</span><span class="special">=</span><span class="number">0</span><span class="special">,</span> <span class="identifier">filesmatched</span><span class="special">=</span><span class="number">0</span><span class="special">;</span>
	<span class="keyword">try</span>
	<span class="special">{</span>
	    <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>

		<span class="comment">// Generate a list of all files here and below the current working directory</span>
		<span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">path</span><span class="special">&gt;</span> <span class="identifier">filepaths</span><span class="special">;</span>
		<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="identifier">it</span><span class="special">=</span><span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">recursive_directory_iterator</span><span class="special">(</span><span class="string">"."</span><span class="special">);</span> <span class="identifier">it</span><span class="special">!=</span><span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">recursive_directory_iterator</span><span class="special">();</span> <span class="special">++</span><span class="identifier">it</span><span class="special">)</span>
		<span class="special">{</span>
			<span class="keyword">if</span><span class="special">(</span><span class="identifier">it</span><span class="special">-&gt;</span><span class="identifier">status</span><span class="special">().</span><span class="identifier">type</span><span class="special">()!=</span><span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">regular_file</span><span class="special">)</span>
				<span class="keyword">continue</span><span class="special">;</span>
			<span class="identifier">filepaths</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">it</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">());</span>
		<span class="special">}</span>

		<span class="comment">// Compile the regular expression, and have OpenMP parallelise the loop</span>
		<span class="identifier">regex</span> <span class="identifier">regexpr</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">]);</span>
<span class="preprocessor">#pragma</span> <span class="identifier">omp</span> <span class="identifier">parallel</span> <span class="keyword">for</span> <span class="identifier">schedule</span><span class="special">(</span><span class="identifier">dynamic</span><span class="special">)</span>
		<span class="keyword">for</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">n</span><span class="special">=</span><span class="number">0</span><span class="special">;</span> <span class="identifier">n</span><span class="special">&lt;(</span><span class="keyword">int</span><span class="special">)</span> <span class="identifier">filepaths</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span> <span class="identifier">n</span><span class="special">++)</span>
		<span class="special">{</span>
			<span class="comment">// Open the file</span>
			<span class="identifier">ifstream</span> <span class="identifier">s</span><span class="special">(</span><span class="identifier">filepaths</span><span class="special">[</span><span class="identifier">n</span><span class="special">],</span> <span class="identifier">ifstream</span><span class="special">::</span><span class="identifier">binary</span><span class="special">);</span>
			<span class="identifier">s</span><span class="special">.</span><span class="identifier">exceptions</span><span class="special">(</span><span class="identifier">fstream</span><span class="special">::</span><span class="identifier">failbit</span> <span class="special">|</span> <span class="identifier">fstream</span><span class="special">::</span><span class="identifier">badbit</span><span class="special">);</span> <span class="comment">// Turn on exception throwing</span>
			<span class="comment">// Get its length</span>
			<span class="identifier">s</span><span class="special">.</span><span class="identifier">seekg</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">ios</span><span class="special">::</span><span class="identifier">end</span><span class="special">);</span>
			<span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">=(</span><span class="identifier">size_t</span><span class="special">)</span> <span class="identifier">s</span><span class="special">.</span><span class="identifier">tellg</span><span class="special">();</span>
			<span class="identifier">s</span><span class="special">.</span><span class="identifier">seekg</span><span class="special">(</span><span class="number">0</span><span class="special">,</span> <span class="identifier">ios</span><span class="special">::</span><span class="identifier">beg</span><span class="special">);</span>
			<span class="comment">// Allocate a sufficient buffer, avoiding the byte clearing vector would do</span>
			<span class="identifier">unique_ptr</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">[]&gt;</span> <span class="identifier">buffer</span><span class="special">(</span><span class="keyword">new</span> <span class="keyword">char</span><span class="special">[</span><span class="identifier">length</span><span class="special">+</span><span class="number">1</span><span class="special">]);</span>
			<span class="comment">// Read in the file, terminating with zero</span>
			<span class="identifier">s</span><span class="special">.</span><span class="identifier">read</span><span class="special">(</span><span class="identifier">buffer</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span> <span class="identifier">length</span><span class="special">);</span>
			<span class="identifier">buffer</span><span class="special">.</span><span class="identifier">get</span><span class="special">()[</span><span class="identifier">length</span><span class="special">]=</span><span class="number">0</span><span class="special">;</span>
			<span class="comment">// Search the buffer for the regular expression</span>
			<span class="keyword">if</span><span class="special">(</span><span class="identifier">regex_search</span><span class="special">(</span><span class="identifier">buffer</span><span class="special">.</span><span class="identifier">get</span><span class="special">(),</span> <span class="identifier">regexpr</span><span class="special">))</span>
			<span class="special">{</span>
<span class="preprocessor">#pragma</span> <span class="identifier">omp</span> <span class="identifier">critical</span>
				<span class="special">{</span>
					<span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">filepaths</span><span class="special">[</span><span class="identifier">n</span><span class="special">]</span> <span class="special">&lt;&lt;</span> <span class="identifier">endl</span><span class="special">;</span>
				<span class="special">}</span>
				<span class="identifier">filesmatched</span><span class="special">++;</span>
			<span class="special">}</span>
			<span class="identifier">filesread</span><span class="special">++;</span>
			<span class="identifier">bytesread</span><span class="special">+=</span><span class="identifier">length</span><span class="special">;</span>
		<span class="special">}</span>
	    <span class="keyword">auto</span> <span class="identifier">end</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
        <span class="keyword">auto</span> <span class="identifier">diff</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">end</span><span class="special">-</span><span class="identifier">begin</span><span class="special">);</span>
		<span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span> <span class="special">&lt;&lt;</span> <span class="identifier">filesmatched</span> <span class="special">&lt;&lt;</span> <span class="string">" files matched out of "</span> <span class="special">&lt;&lt;</span> <span class="identifier">filesread</span> <span class="special">&lt;&lt;</span> <span class="string">" files which was "</span> <span class="special">&lt;&lt;</span> <span class="identifier">bytesread</span> <span class="special">&lt;&lt;</span> <span class="string">" bytes."</span> <span class="special">&lt;&lt;</span> <span class="identifier">endl</span><span class="special">;</span>
		<span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"The search took "</span> <span class="special">&lt;&lt;</span> <span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" seconds which was "</span> <span class="special">&lt;&lt;</span> <span class="identifier">filesread</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" files per second or "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">bytesread</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()/</span><span class="number">1024</span><span class="special">/</span><span class="number">1024</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" Mb/sec."</span> <span class="special">&lt;&lt;</span> <span class="identifier">endl</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="keyword">catch</span><span class="special">(...)</span>
	<span class="special">{</span>
		<span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">current_exception_diagnostic_information</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          This implementation is fairly straightforward: enumerate all files in all
          directories below the current directory into a vector, fire off N threads
          to open each file, read it entirely into memory, regex it for the pattern
          and if found print the file's path.
        </p>
<p>
          Let's now look at the AFIO implementation, and you should prepare yourself
          because it is far more mind bendy due to the many nestings of callbacks
          needed (it may remind you of WinRT or .NET code, everything is asynchronous
          callback):
        </p>
<pre class="programlisting"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">;</span>

<span class="comment">// Often it's easiest for a lot of nesting callbacks to carry state via a this pointer</span>
<span class="keyword">class</span> <span class="identifier">find_in_files</span>
<span class="special">{</span>
<span class="keyword">public</span><span class="special">:</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">promise</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span> <span class="identifier">finished</span><span class="special">;</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">regex</span> <span class="identifier">regexpr</span><span class="special">;</span> <span class="comment">// The precompiled regular expression</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">&gt;</span> <span class="identifier">dispatcher</span><span class="special">;</span>
	<span class="identifier">recursive_mutex</span> <span class="identifier">opslock</span><span class="special">;</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">deque</span><span class="special">&lt;</span><span class="identifier">async_io_op</span><span class="special">&gt;</span> <span class="identifier">ops</span><span class="special">;</span> <span class="comment">// For exception gathering</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">atomic</span><span class="special">&lt;</span><span class="identifier">size_t</span><span class="special">&gt;</span> <span class="identifier">bytesread</span><span class="special">,</span> <span class="identifier">filesread</span><span class="special">,</span> <span class="identifier">filesmatched</span><span class="special">,</span> <span class="identifier">scheduled</span><span class="special">,</span> <span class="identifier">completed</span><span class="special">;</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">filesystem</span><span class="special">::</span><span class="identifier">path</span><span class="special">,</span> <span class="identifier">size_t</span><span class="special">&gt;&gt;</span> <span class="identifier">filepaths</span><span class="special">;</span>

	<span class="comment">// Signals finish once all scheduled ops have completed</span>
	<span class="keyword">void</span> <span class="identifier">docompleted</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">inc</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">size_t</span> <span class="identifier">c</span><span class="special">=(</span><span class="identifier">completed</span><span class="special">+=</span><span class="identifier">inc</span><span class="special">);</span>
		<span class="keyword">if</span><span class="special">(</span><span class="identifier">c</span><span class="special">==</span><span class="identifier">scheduled</span><span class="special">)</span>
			<span class="identifier">finished</span><span class="special">.</span><span class="identifier">set_value</span><span class="special">(</span><span class="number">0</span><span class="special">);</span>
	<span class="special">};</span>
	<span class="comment">// Adds ops to the list of scheduled</span>
	<span class="keyword">void</span> <span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">initializer_list</span><span class="special">&lt;</span><span class="identifier">async_io_op</span><span class="special">&gt;</span> <span class="identifier">list</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">scheduled</span><span class="special">+=</span><span class="identifier">list</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span>
		<span class="comment">//boost::lock_guard&lt;decltype(opslock)&gt; lock(opslock);</span>
		<span class="comment">//ops.insert(ops.end(), list.begin(), list.end());</span>
	<span class="special">}</span>
	<span class="keyword">void</span> <span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">async_io_op</span><span class="special">&gt;</span> <span class="identifier">list</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">scheduled</span><span class="special">+=</span><span class="identifier">list</span><span class="special">.</span><span class="identifier">size</span><span class="special">();</span>
		<span class="comment">//boost::lock_guard&lt;decltype(opslock)&gt; lock(opslock);</span>
		<span class="comment">//ops.insert(ops.end(), list.begin(), list.end());</span>
	<span class="special">}</span>
	<span class="keyword">void</span> <span class="identifier">dosearch</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span><span class="identifier">buffer</span><span class="special">,</span> <span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="comment">// Search the buffer for the regular expression</span>
		<span class="keyword">if</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">regex_search</span><span class="special">(</span><span class="identifier">buffer</span><span class="special">,</span> <span class="identifier">regexpr</span><span class="special">))</span>
		<span class="special">{</span>
<span class="preprocessor">#pragma</span> <span class="identifier">omp</span> <span class="identifier">critical</span>
			<span class="special">{</span>
				<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
			<span class="special">}</span>
			<span class="special">++</span><span class="identifier">filesmatched</span><span class="special">;</span>
		<span class="special">}</span>
		<span class="special">++</span><span class="identifier">filesread</span><span class="special">;</span>
		<span class="identifier">bytesread</span><span class="special">+=</span><span class="identifier">length</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="comment">// A file searching completion, called when each file read completes</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;&gt;</span> <span class="identifier">file_read</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">,</span> <span class="identifier">exception_ptr</span> <span class="special">*</span><span class="identifier">e</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">aligned_allocator</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span> <span class="number">4096</span><span class="special">,</span> <span class="keyword">false</span><span class="special">&gt;&gt;&gt;</span> <span class="identifier">_buffer</span><span class="special">,</span> <span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="comment">//std::cout &lt;&lt; "R " &lt;&lt; h-&gt;path() &lt;&lt; std::endl;</span>
		<span class="keyword">char</span> <span class="special">*</span><span class="identifier">buffer</span><span class="special">=</span><span class="identifier">_buffer</span><span class="special">-&gt;</span><span class="identifier">data</span><span class="special">();</span>
		<span class="identifier">buffer</span><span class="special">[</span><span class="identifier">length</span><span class="special">]=</span><span class="number">0</span><span class="special">;</span>
		<span class="identifier">dosearch</span><span class="special">(</span><span class="identifier">h</span><span class="special">,</span> <span class="identifier">buffer</span><span class="special">,</span> <span class="identifier">length</span><span class="special">);</span>
		<span class="identifier">docompleted</span><span class="special">(</span><span class="number">2</span><span class="special">);</span>
		<span class="comment">// Throw away the buffer now rather than later to keep memory consumption down</span>
		<span class="identifier">_buffer</span><span class="special">-&gt;</span><span class="identifier">clear</span><span class="special">();</span>
		<span class="comment">// Schedule an immediate close rather than lazy close to keep file handle count down</span>
		<span class="comment">//auto close=dispatcher-&gt;close(dispatcher-&gt;op_from_scheduled_id(id));</span>
		<span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">h</span><span class="special">);</span>
	<span class="special">}</span>
	<span class="comment">// A file reading completion, called when each file open completes</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;&gt;</span> <span class="identifier">file_opened</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">,</span> <span class="identifier">exception_ptr</span> <span class="special">*</span><span class="identifier">e</span><span class="special">,</span> <span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="comment">//std::cout &lt;&lt; "F " &lt;&lt; h-&gt;path() &lt;&lt; std::endl;</span>
<span class="preprocessor">#ifdef</span> <span class="identifier">USE_MMAPS</span>
		<span class="keyword">if</span><span class="special">(!!(</span><span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">flags</span><span class="special">()</span> <span class="special">&amp;</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">OSMMap</span><span class="special">))</span>
		<span class="special">{</span>
			<span class="identifier">dosearch</span><span class="special">(</span><span class="identifier">h</span><span class="special">,</span> <span class="special">(</span><span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*)</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">try_mapfile</span><span class="special">(),</span> <span class="identifier">length</span><span class="special">);</span>
		<span class="special">}</span>
		<span class="keyword">else</span>
<span class="preprocessor">#endif</span>
		<span class="special">{</span>
			<span class="comment">// Allocate a sufficient 4Kb aligned buffer</span>
			<span class="identifier">size_t</span> <span class="identifier">_length</span><span class="special">=(</span><span class="number">4095</span><span class="special">+</span><span class="identifier">length</span><span class="special">)&amp;~</span><span class="number">4095</span><span class="special">;</span>
			<span class="keyword">auto</span> <span class="identifier">buffer</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_shared</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">aligned_allocator</span><span class="special">&lt;</span><span class="keyword">char</span><span class="special">,</span> <span class="number">4096</span><span class="special">,</span> <span class="keyword">false</span><span class="special">&gt;&gt;&gt;(</span><span class="identifier">_length</span><span class="special">+</span><span class="number">1</span><span class="special">);</span>
			<span class="comment">// Schedule a read of the file</span>
			<span class="keyword">auto</span> <span class="identifier">read</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">read</span><span class="special">(</span><span class="identifier">make_async_data_op_req</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">op_from_scheduled_id</span><span class="special">(</span><span class="identifier">id</span><span class="special">),</span> <span class="identifier">buffer</span><span class="special">-&gt;</span><span class="identifier">data</span><span class="special">(),</span> <span class="identifier">_length</span><span class="special">,</span> <span class="number">0</span><span class="special">));</span>
			<span class="keyword">auto</span> <span class="identifier">read_done</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">read</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="comment">/*regex search might be slow*/</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">file_read</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">,</span> <span class="identifier">buffer</span><span class="special">,</span> <span class="identifier">length</span><span class="special">)));</span>
			<span class="identifier">doscheduled</span><span class="special">({</span> <span class="identifier">read</span><span class="special">,</span> <span class="identifier">read_done</span> <span class="special">});</span>
		<span class="special">}</span>
		<span class="identifier">docompleted</span><span class="special">(</span><span class="number">2</span><span class="special">);</span>
		<span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">h</span><span class="special">);</span>
	<span class="special">}</span>
	<span class="comment">// An enumeration parsing completion, called when each directory enumeration completes</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;&gt;</span> <span class="identifier">dir_enumerated</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">,</span> <span class="identifier">exception_ptr</span> <span class="special">*</span><span class="identifier">e</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">directory_entry</span><span class="special">&gt;,</span> <span class="keyword">bool</span><span class="special">&gt;&gt;&gt;</span> <span class="identifier">listing</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">async_io_op</span> <span class="identifier">lastdir</span><span class="special">,</span> <span class="identifier">thisop</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">op_from_scheduled_id</span><span class="special">(</span><span class="identifier">id</span><span class="special">));</span>
		<span class="comment">// Get the entries from the ready future</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">directory_entry</span><span class="special">&gt;</span> <span class="identifier">entries</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">listing</span><span class="special">-&gt;</span><span class="identifier">get</span><span class="special">().</span><span class="identifier">first</span><span class="special">));</span>
		<span class="comment">//std::cout &lt;&lt; "E " &lt;&lt; h-&gt;path() &lt;&lt; std::endl;</span>
		<span class="comment">// For each of the directories schedule an open and enumeration</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="special">{</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">async_path_op_req</span><span class="special">&gt;</span> <span class="identifier">dir_reqs</span><span class="special">;</span> <span class="identifier">dir_reqs</span><span class="special">.</span><span class="identifier">reserve</span><span class="special">(</span><span class="identifier">entries</span><span class="special">.</span><span class="identifier">size</span><span class="special">());</span>
			<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">entry</span> <span class="special">:</span> <span class="identifier">entries</span><span class="special">)</span>
			<span class="special">{</span>
				<span class="keyword">if</span><span class="special">((</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_type</span><span class="special">()&amp;</span><span class="identifier">S_IFDIR</span><span class="special">)==</span><span class="identifier">S_IFDIR</span><span class="special">)</span>
				<span class="special">{</span>
					<span class="identifier">dir_reqs</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="identifier">thisop</span><span class="special">,</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">()/</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">name</span><span class="special">()));</span>
				<span class="special">}</span>
			<span class="special">}</span>
			<span class="keyword">if</span><span class="special">(!</span><span class="identifier">dir_reqs</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
			<span class="special">{</span>
				<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">async_op_flags</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">completion_t</span><span class="special">&gt;&gt;&gt;</span> <span class="identifier">dir_openedfs</span><span class="special">(</span><span class="identifier">dir_reqs</span><span class="special">.</span><span class="identifier">size</span><span class="special">(),</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">dir_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">)));</span>
				<span class="keyword">auto</span> <span class="identifier">dir_opens</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">dir</span><span class="special">(</span><span class="identifier">dir_reqs</span><span class="special">);</span>
				<span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">dir_opens</span><span class="special">);</span>
				<span class="keyword">auto</span> <span class="identifier">dir_openeds</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">dir_opens</span><span class="special">,</span> <span class="identifier">dir_openedfs</span><span class="special">);</span>
				<span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">dir_openeds</span><span class="special">);</span>
				<span class="comment">// Hold back some of the concurrency</span>
				<span class="identifier">lastdir</span><span class="special">=</span><span class="identifier">dir_openeds</span><span class="special">.</span><span class="identifier">back</span><span class="special">();</span>
			<span class="special">}</span>
		<span class="special">}</span>
<span class="preprocessor">#else</span>
		<span class="comment">// The Windows NT kernel filing system driver gets upset with too much concurrency</span>
		<span class="comment">// when used with OSDirect so throttle directory enumerations to enforce some depth first traversal.</span>
		<span class="special">{</span>
			<span class="keyword">auto</span> <span class="identifier">dir_openedf</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">dir_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">));</span>
			<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">entry</span> <span class="special">:</span> <span class="identifier">entries</span><span class="special">)</span>
			<span class="special">{</span>
				<span class="keyword">if</span><span class="special">((</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_type</span><span class="special">()&amp;</span><span class="identifier">S_IFDIR</span><span class="special">)==</span><span class="identifier">S_IFDIR</span><span class="special">)</span>
				<span class="special">{</span>
					<span class="keyword">auto</span> <span class="identifier">dir_open</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">dir</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="identifier">lastdir</span><span class="special">,</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">()/</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">name</span><span class="special">()));</span>
					<span class="keyword">auto</span> <span class="identifier">dir_opened</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">dir_open</span><span class="special">,</span> <span class="identifier">dir_openedf</span><span class="special">);</span>
					<span class="identifier">doscheduled</span><span class="special">({</span> <span class="identifier">dir_open</span><span class="special">,</span> <span class="identifier">dir_opened</span> <span class="special">});</span>
					<span class="identifier">lastdir</span><span class="special">=</span><span class="identifier">dir_opened</span><span class="special">;</span>
				<span class="special">}</span>
			<span class="special">}</span>
		<span class="special">}</span>
<span class="preprocessor">#endif</span>

		<span class="comment">// For each of the files schedule an open and search</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="special">{</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">async_path_op_req</span><span class="special">&gt;</span> <span class="identifier">file_reqs</span><span class="special">;</span> <span class="identifier">file_reqs</span><span class="special">.</span><span class="identifier">reserve</span><span class="special">(</span><span class="identifier">entries</span><span class="special">.</span><span class="identifier">size</span><span class="special">());</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">async_op_flags</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">function</span><span class="special">&lt;</span><span class="identifier">async_file_io_dispatcher_base</span><span class="special">::</span><span class="identifier">completion_t</span><span class="special">&gt;&gt;&gt;</span> <span class="identifier">file_openedfs</span><span class="special">;</span> <span class="identifier">file_openedfs</span><span class="special">.</span><span class="identifier">reserve</span><span class="special">(</span><span class="identifier">entries</span><span class="special">.</span><span class="identifier">size</span><span class="special">());</span>
			<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">entry</span> <span class="special">:</span> <span class="identifier">entries</span><span class="special">)</span>
			<span class="special">{</span>
				<span class="keyword">if</span><span class="special">((</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_type</span><span class="special">()&amp;</span><span class="identifier">S_IFREG</span><span class="special">)==</span><span class="identifier">S_IFREG</span><span class="special">)</span>
				<span class="special">{</span>
					<span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">=(</span><span class="identifier">size_t</span><span class="special">)</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_size</span><span class="special">();</span>
					<span class="keyword">if</span><span class="special">(</span><span class="identifier">length</span><span class="special">)</span>
					<span class="special">{</span>
						<span class="identifier">file_flags</span> <span class="identifier">flags</span><span class="special">=</span><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Read</span><span class="special">;</span>
<span class="preprocessor">#ifdef</span> <span class="identifier">USE_MMAPS</span>
						<span class="keyword">if</span><span class="special">(</span><span class="identifier">length</span><span class="special">&gt;</span><span class="number">16384</span><span class="special">)</span> <span class="identifier">flags</span><span class="special">=</span><span class="identifier">flags</span><span class="special">|</span><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">OSMMap</span><span class="special">;</span>
<span class="preprocessor">#endif</span>
						<span class="identifier">file_reqs</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="identifier">lastdir</span><span class="special">,</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">()/</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">name</span><span class="special">(),</span> <span class="identifier">flags</span><span class="special">));</span>
						<span class="identifier">file_openedfs</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">file_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">,</span> <span class="identifier">length</span><span class="special">)));</span>
					<span class="special">}</span>
				<span class="special">}</span>
			<span class="special">}</span>
			<span class="keyword">auto</span> <span class="identifier">file_opens</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">file_reqs</span><span class="special">);</span>
			<span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">file_opens</span><span class="special">);</span>
			<span class="keyword">auto</span> <span class="identifier">file_openeds</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">file_opens</span><span class="special">,</span> <span class="identifier">file_openedfs</span><span class="special">);</span>
			<span class="identifier">doscheduled</span><span class="special">(</span><span class="identifier">file_openeds</span><span class="special">);</span>
		<span class="special">}</span>
<span class="preprocessor">#else</span>
		<span class="special">{</span>
			<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">entry</span> <span class="special">:</span> <span class="identifier">entries</span><span class="special">)</span>
			<span class="special">{</span>
				<span class="keyword">if</span><span class="special">((</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_type</span><span class="special">()&amp;</span><span class="identifier">S_IFREG</span><span class="special">)==</span><span class="identifier">S_IFREG</span><span class="special">)</span>
				<span class="special">{</span>
					<span class="identifier">size_t</span> <span class="identifier">length</span><span class="special">=(</span><span class="identifier">size_t</span><span class="special">)</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">st_size</span><span class="special">();</span>
					<span class="keyword">if</span><span class="special">(</span><span class="identifier">length</span><span class="special">)</span>
					<span class="special">{</span>
						<span class="identifier">file_flags</span> <span class="identifier">flags</span><span class="special">=</span><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Read</span><span class="special">;</span>
<span class="preprocessor">#ifdef</span> <span class="identifier">USE_MMAPS</span>
						<span class="keyword">if</span><span class="special">(</span><span class="identifier">length</span><span class="special">&gt;</span><span class="number">16384</span><span class="special">)</span> <span class="identifier">flags</span><span class="special">=</span><span class="identifier">flags</span><span class="special">|</span><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">OSMMap</span><span class="special">;</span>
<span class="preprocessor">#endif</span>
						<span class="keyword">auto</span> <span class="identifier">file_open</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="identifier">lastdir</span><span class="special">,</span> <span class="identifier">h</span><span class="special">-&gt;</span><span class="identifier">path</span><span class="special">()/</span><span class="identifier">entry</span><span class="special">.</span><span class="identifier">name</span><span class="special">(),</span> <span class="identifier">flags</span><span class="special">));</span>
						<span class="keyword">auto</span> <span class="identifier">file_opened</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">file_open</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">file_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">,</span> <span class="identifier">length</span><span class="special">)));</span>
						<span class="identifier">doscheduled</span><span class="special">({</span> <span class="identifier">file_open</span><span class="special">,</span> <span class="identifier">file_opened</span> <span class="special">});</span>
						<span class="identifier">lastdir</span><span class="special">=</span><span class="identifier">file_opened</span><span class="special">;</span>
					<span class="special">}</span>
				<span class="special">}</span>
			<span class="special">}</span>
		<span class="special">}</span>
<span class="preprocessor">#endif</span>
		<span class="identifier">docompleted</span><span class="special">(</span><span class="number">2</span><span class="special">);</span>
		<span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">h</span><span class="special">);</span>
	<span class="special">}</span>
	<span class="comment">// A directory enumerating completion, called once per directory open in the tree</span>
	<span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="keyword">bool</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;&gt;</span> <span class="identifier">dir_opened</span><span class="special">(</span><span class="identifier">size_t</span> <span class="identifier">id</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">shared_ptr</span><span class="special">&lt;</span><span class="identifier">async_io_handle</span><span class="special">&gt;</span> <span class="identifier">h</span><span class="special">,</span> <span class="identifier">exception_ptr</span> <span class="special">*</span><span class="identifier">e</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="comment">//std::cout &lt;&lt; "D " &lt;&lt; h-&gt;path() &lt;&lt; std::endl;</span>
		<span class="comment">// Now we have an open directory handle, schedule an enumeration</span>
		<span class="keyword">auto</span> <span class="identifier">enumeration</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">enumerate</span><span class="special">(</span><span class="identifier">async_enumerate_op_req</span><span class="special">(</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">op_from_scheduled_id</span><span class="special">(</span><span class="identifier">id</span><span class="special">),</span> <span class="number">1000</span><span class="special">));</span>
		<span class="keyword">auto</span> <span class="identifier">listing</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">make_shared</span><span class="special">&lt;</span><span class="identifier">future</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">pair</span><span class="special">&lt;</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">directory_entry</span><span class="special">&gt;,</span> <span class="keyword">bool</span><span class="special">&gt;&gt;&gt;(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">enumeration</span><span class="special">.</span><span class="identifier">first</span><span class="special">));</span>
		<span class="keyword">auto</span> <span class="identifier">enumeration_done</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">enumeration</span><span class="special">.</span><span class="identifier">second</span><span class="special">,</span> <span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">dir_enumerated</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">,</span> <span class="identifier">listing</span><span class="special">)));</span>
		<span class="identifier">doscheduled</span><span class="special">({</span><span class="identifier">enumeration</span><span class="special">.</span><span class="identifier">second</span><span class="special">,</span> <span class="identifier">enumeration_done</span><span class="special">});</span>
		<span class="identifier">docompleted</span><span class="special">(</span><span class="number">2</span><span class="special">);</span>
		<span class="comment">// Complete only if not the cur dir opened</span>
		<span class="keyword">return</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="keyword">true</span><span class="special">,</span> <span class="identifier">h</span><span class="special">);</span>
	<span class="special">};</span>
	<span class="keyword">void</span> <span class="identifier">dowait</span><span class="special">()</span>
	<span class="special">{</span>
		<span class="comment">// Prepare finished</span>
		<span class="keyword">auto</span> <span class="identifier">finished_waiter</span><span class="special">=</span><span class="identifier">finished</span><span class="special">.</span><span class="identifier">get_future</span><span class="special">();</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="comment">// Wait till done, retrieving any exceptions as they come in to keep memory consumption down</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">future_status</span> <span class="identifier">status</span><span class="special">;</span>
		<span class="keyword">do</span>
		<span class="special">{</span>
			<span class="identifier">status</span><span class="special">=</span><span class="identifier">finished_waiter</span><span class="special">.</span><span class="identifier">wait_for</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">milliseconds</span><span class="special">(</span><span class="number">1000</span><span class="special">));</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\nDispatcher has "</span> <span class="special">&lt;&lt;</span> <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">count</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" fds open and "</span> <span class="special">&lt;&lt;</span> <span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">wait_queue_depth</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" ops outstanding."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">vector</span><span class="special">&lt;</span><span class="identifier">async_io_op</span><span class="special">&gt;</span> <span class="identifier">batch</span><span class="special">;</span> <span class="identifier">batch</span><span class="special">.</span><span class="identifier">reserve</span><span class="special">(</span><span class="number">10000</span><span class="special">);</span>
			<span class="special">{</span>
				<span class="identifier">boost</span><span class="special">::</span><span class="identifier">lock_guard</span><span class="special">&lt;</span><span class="keyword">decltype</span><span class="special">(</span><span class="identifier">opslock</span><span class="special">)&gt;</span> <span class="identifier">lock</span><span class="special">(</span><span class="identifier">opslock</span><span class="special">);</span>
				<span class="keyword">while</span><span class="special">(</span><span class="identifier">status</span><span class="special">==</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">future_status</span><span class="special">::</span><span class="identifier">timeout</span> <span class="special">?</span> <span class="special">(</span><span class="identifier">ops</span><span class="special">.</span><span class="identifier">size</span><span class="special">()&gt;</span><span class="number">5000</span><span class="special">)</span> <span class="special">:</span> <span class="special">!</span><span class="identifier">ops</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
				<span class="special">{</span>
					<span class="identifier">batch</span><span class="special">.</span><span class="identifier">push_back</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">ops</span><span class="special">.</span><span class="identifier">front</span><span class="special">()));</span>
					<span class="identifier">ops</span><span class="special">.</span><span class="identifier">pop_front</span><span class="special">();</span>
				<span class="special">}</span>
			<span class="special">}</span>
			<span class="comment">// Retrieve any exceptions</span>
			<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Processed "</span> <span class="special">&lt;&lt;</span> <span class="identifier">batch</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" ops for exception state."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
			<span class="keyword">if</span><span class="special">(!</span><span class="identifier">batch</span><span class="special">.</span><span class="identifier">empty</span><span class="special">())</span>
				<span class="identifier">when_all</span><span class="special">(</span><span class="identifier">batch</span><span class="special">.</span><span class="identifier">begin</span><span class="special">(),</span> <span class="identifier">batch</span><span class="special">.</span><span class="identifier">end</span><span class="special">()).</span><span class="identifier">wait</span><span class="special">();</span>
		<span class="special">}</span> <span class="keyword">while</span><span class="special">(</span><span class="identifier">status</span><span class="special">==</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">future_status</span><span class="special">::</span><span class="identifier">timeout</span><span class="special">);</span>
<span class="preprocessor">#else</span>
		<span class="identifier">finished_waiter</span><span class="special">.</span><span class="identifier">wait</span><span class="special">();</span>
<span class="preprocessor">#endif</span>
	<span class="special">}</span>
	<span class="comment">// Constructor, which starts the ball rolling</span>
	<span class="identifier">find_in_files</span><span class="special">(</span><span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span><span class="identifier">_regexpr</span><span class="special">)</span> <span class="special">:</span> <span class="identifier">regexpr</span><span class="special">(</span><span class="identifier">_regexpr</span><span class="special">),</span>
		<span class="comment">// Create an AFIO dispatcher that bypasses any filing system buffers</span>
		<span class="identifier">dispatcher</span><span class="special">(</span><span class="identifier">make_async_file_io_dispatcher</span><span class="special">(</span><span class="identifier">process_threadpool</span><span class="special">(),</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">WillBeSequentiallyAccessed</span><span class="comment">/*|file_flags::OSDirect*/</span><span class="special">)),</span>
		<span class="identifier">bytesread</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">filesread</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">filesmatched</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">scheduled</span><span class="special">(</span><span class="number">0</span><span class="special">),</span> <span class="identifier">completed</span><span class="special">(</span><span class="number">0</span><span class="special">)</span>
	<span class="special">{</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Attach profiler, and press return to continue."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="identifier">getchar</span><span class="special">();</span>
<span class="preprocessor">#endif</span>
		<span class="identifier">filepaths</span><span class="special">.</span><span class="identifier">reserve</span><span class="special">(</span><span class="number">50000</span><span class="special">);</span>

		<span class="comment">// Schedule the recursive enumeration of the current directory</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\n\nStarting directory enumerations ..."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">auto</span> <span class="identifier">cur_dir</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">dir</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="string">""</span><span class="special">));</span>
		<span class="keyword">auto</span> <span class="identifier">cur_dir_opened</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">cur_dir</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">dir_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">)));</span>
		<span class="identifier">doscheduled</span><span class="special">({</span><span class="identifier">cur_dir</span><span class="special">,</span> <span class="identifier">cur_dir_opened</span><span class="special">});</span>
		<span class="identifier">dowait</span><span class="special">();</span>

<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="comment">// Reset the waiter, and issue the searches</span>
		<span class="identifier">finished</span><span class="special">=</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">promise</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;();</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\n\nStarting searches of "</span> <span class="special">&lt;&lt;</span> <span class="identifier">filepaths</span><span class="special">.</span><span class="identifier">size</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" files ..."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">for</span><span class="special">(</span><span class="keyword">auto</span> <span class="special">&amp;</span><span class="identifier">filepath</span> <span class="special">:</span> <span class="identifier">filepaths</span><span class="special">)</span>
		<span class="special">{</span>
			<span class="keyword">auto</span> <span class="identifier">cur</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">file</span><span class="special">(</span><span class="identifier">async_path_op_req</span><span class="special">(</span><span class="identifier">filepath</span><span class="special">.</span><span class="identifier">first</span><span class="special">,</span> <span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">Read</span><span class="special">));</span>
			<span class="keyword">auto</span> <span class="identifier">cur_opened</span><span class="special">=</span><span class="identifier">dispatcher</span><span class="special">-&gt;</span><span class="identifier">completion</span><span class="special">(</span><span class="identifier">cur</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">make_pair</span><span class="special">(</span><span class="identifier">async_op_flags</span><span class="special">::</span><span class="identifier">None</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">bind</span><span class="special">(&amp;</span><span class="identifier">find_in_files</span><span class="special">::</span><span class="identifier">file_opened</span><span class="special">,</span> <span class="keyword">this</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">,</span> <span class="identifier">filepath</span><span class="special">.</span><span class="identifier">second</span><span class="special">)));</span>
			<span class="identifier">doscheduled</span><span class="special">({</span><span class="identifier">cur</span><span class="special">,</span> <span class="identifier">cur_opened</span><span class="special">});</span>
		<span class="special">}</span>
		<span class="identifier">dowait</span><span class="special">();</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor">#if</span> <span class="number">0</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"Stop profiler, and press return to continue."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="identifier">getchar</span><span class="special">();</span>
<span class="preprocessor">#endif</span>
	<span class="special">}</span>
<span class="special">};</span>

<span class="keyword">int</span> <span class="identifier">main</span><span class="special">(</span><span class="keyword">int</span> <span class="identifier">argc</span><span class="special">,</span> <span class="keyword">const</span> <span class="keyword">char</span> <span class="special">*</span><span class="identifier">argv</span><span class="special">[])</span>
<span class="special">{</span>
	<span class="keyword">using</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_1</span><span class="special">;</span> <span class="keyword">using</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_2</span><span class="special">;</span> <span class="keyword">using</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">placeholders</span><span class="special">::</span><span class="identifier">_3</span><span class="special">;</span>
	<span class="keyword">using</span> <span class="keyword">namespace</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">afio</span><span class="special">;</span>
	<span class="keyword">typedef</span> <span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration</span><span class="special">&lt;</span><span class="keyword">double</span><span class="special">,</span> <span class="identifier">ratio</span><span class="special">&lt;</span><span class="number">1</span><span class="special">&gt;&gt;</span> <span class="identifier">secs_type</span><span class="special">;</span>
	<span class="keyword">if</span><span class="special">(</span><span class="identifier">argc</span><span class="special">&lt;</span><span class="number">2</span><span class="special">)</span>
	<span class="special">{</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="string">"ERROR: Specify a regular expression to search all files in the current directory."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="comment">// Prime SpeedStep</span>
    <span class="keyword">auto</span> <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
    <span class="keyword">while</span><span class="special">(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">()-</span><span class="identifier">begin</span><span class="special">).</span><span class="identifier">count</span><span class="special">()&lt;</span><span class="number">1</span><span class="special">);</span>
	<span class="keyword">try</span>
	<span class="special">{</span>
	    <span class="identifier">begin</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
		<span class="identifier">find_in_files</span> <span class="identifier">finder</span><span class="special">(</span><span class="identifier">argv</span><span class="special">[</span><span class="number">1</span><span class="special">]);</span>
	    <span class="keyword">auto</span> <span class="identifier">end</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">high_resolution_clock</span><span class="special">::</span><span class="identifier">now</span><span class="special">();</span>
        <span class="keyword">auto</span> <span class="identifier">diff</span><span class="special">=</span><span class="identifier">chrono</span><span class="special">::</span><span class="identifier">duration_cast</span><span class="special">&lt;</span><span class="identifier">secs_type</span><span class="special">&gt;(</span><span class="identifier">end</span><span class="special">-</span><span class="identifier">begin</span><span class="special">);</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"\n"</span> <span class="special">&lt;&lt;</span> <span class="identifier">finder</span><span class="special">.</span><span class="identifier">filesmatched</span> <span class="special">&lt;&lt;</span> <span class="string">" files matched out of "</span> <span class="special">&lt;&lt;</span> <span class="identifier">finder</span><span class="special">.</span><span class="identifier">filesread</span> <span class="special">&lt;&lt;</span> <span class="string">" files which was "</span> <span class="special">&lt;&lt;</span> <span class="identifier">finder</span><span class="special">.</span><span class="identifier">bytesread</span> <span class="special">&lt;&lt;</span> <span class="string">" bytes."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cout</span> <span class="special">&lt;&lt;</span> <span class="string">"The search took "</span> <span class="special">&lt;&lt;</span> <span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" seconds which was "</span> <span class="special">&lt;&lt;</span> <span class="identifier">finder</span><span class="special">.</span><span class="identifier">filesread</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()</span> <span class="special">&lt;&lt;</span> <span class="string">" files per second or "</span> <span class="special">&lt;&lt;</span> <span class="special">(</span><span class="identifier">finder</span><span class="special">.</span><span class="identifier">bytesread</span><span class="special">/</span><span class="identifier">diff</span><span class="special">.</span><span class="identifier">count</span><span class="special">()/</span><span class="number">1024</span><span class="special">/</span><span class="number">1024</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="string">" Mb/sec."</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="keyword">catch</span><span class="special">(...)</span>
	<span class="special">{</span>
		<span class="identifier">std</span><span class="special">::</span><span class="identifier">cerr</span> <span class="special">&lt;&lt;</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">current_exception_diagnostic_information</span><span class="special">(</span><span class="keyword">true</span><span class="special">)</span> <span class="special">&lt;&lt;</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">endl</span><span class="special">;</span>
		<span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
	<span class="special">}</span>
	<span class="keyword">return</span> <span class="number">0</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          Here the <code class="computeroutput"><span class="identifier">find_in_files</span></code>
          class is used to carry state across the callbacks -- one could just as
          equally bind the state into each callback's parameters instead via some
          sort of pointer to a struct. But the difference in complexity is noticeable
          -- you're probably now asking, why choose this hideous complexity over
          the much clearer OpenMP and iostreams implementation<a href="#ftn.afio.quickstart.async_file_io.so_what.f0" class="footnote" name="afio.quickstart.async_file_io.so_what.f0"><sup class="footnote">[10]</sup></a>?
        </p>
<p>
          Well, that's simple: do you want maximum file i/o performance? Here is
          a search for <span class="quote">&#8220;<span class="quote">Niall</span>&#8221;</span> in a Boost working directory which contained
          about 6Gb of data across ~39k files<a href="#ftn.afio.quickstart.async_file_io.so_what.f1" class="footnote" name="afio.quickstart.async_file_io.so_what.f1"><sup class="footnote">[11]</sup></a>:
        </p>
<div class="table">
<a name="afio.quickstart.async_file_io.so_what.find_in_files_performance"></a><p class="title"><b>Table&#160;1.4.&#160;Find in files performance for traditional vs AFIO implementations</b></p>
<div class="table-contents"><table class="table" summary="Find in files performance for traditional vs AFIO implementations">
<colgroup>
<col>
<col>
<col>
<col>
<col>
<col>
</colgroup>
<thead><tr>
<th>
                </th>
<th>
                  <p>
                    iostreams, single threaded
                  </p>
                </th>
<th>
                  <p>
                    iostreams, OpenMP
                  </p>
                </th>
<th>
                  <p>
                    Boost.AFIO
                  </p>
                </th>
<th>
                  <p>
                    Boost.AFIO <code class="computeroutput"><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">OSDirect</span></code>
                  </p>
                </th>
<th>
                  <p>
                    Boost.AFIO <code class="computeroutput"><span class="identifier">file_flags</span><span class="special">::</span><span class="identifier">OSMMap</span></code><a href="#ftn.afio.quickstart.async_file_io.so_what.f2" class="footnote" name="afio.quickstart.async_file_io.so_what.f2"><sup class="footnote">[a]</sup></a>
                  </p>
                </th>
</tr></thead>
<tbody>
<tr>
<td>
                  <p>
                    Warm cache
                  </p>
                </td>
<td>
                  <p>
                    779 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    1682 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    2086 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    N/A
                  </p>
                </td>
<td>
                  <p>
                    3761 Mb/sec
                  </p>
                </td>
</tr>
<tr>
<td>
                </td>
<td>
                  <p>
                    +0%
                  </p>
                </td>
<td>
                  <p>
                    +116%
                  </p>
                </td>
<td>
                  <p>
                    +168%
                  </p>
                </td>
<td>
                </td>
<td>
                  <p>
                    +383%
                  </p>
                </td>
</tr>
<tr>
<td>
                  <p>
                    Cold cache<a href="#ftn.afio.quickstart.async_file_io.so_what.f3" class="footnote" name="afio.quickstart.async_file_io.so_what.f3"><sup class="footnote">[b]</sup></a>
                  </p>
                </td>
<td>
                  <p>
                    16 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    8 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    15 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    13.14 Mb/sec
                  </p>
                </td>
<td>
                  <p>
                    24 Mb/sec
                  </p>
                </td>
</tr>
<tr>
<td>
                </td>
<td>
                  <p>
                    +0%
                  </p>
                </td>
<td>
                  <p>
                    -50%
                  </p>
                </td>
<td>
                  <p>
                    -6%
                  </p>
                </td>
<td>
                  <p>
                    -18%
                  </p>
                </td>
<td>
                  <p>
                    +50%
                  </p>
                </td>
</tr>
</tbody>
<tbody class="footnotes"><tr><td colspan="6">
<div id="ftn.afio.quickstart.async_file_io.so_what.f2" class="footnote"><p><a href="#afio.quickstart.async_file_io.so_what.f2" class="para"><sup class="para">[a] </sup></a>
                      The superiority of memory maps on Windows is because all buffered
                      file i/o is done via memory copying to/from memory maps on
                      Windows anyway, so eliminating that memory copy is huge.
                    </p></div>
<div id="ftn.afio.quickstart.async_file_io.so_what.f3" class="footnote"><p><a href="#afio.quickstart.async_file_io.so_what.f3" class="para"><sup class="para">[b] </sup></a>
                      File cache reset using <a href="http://technet.microsoft.com/en-us/sysinternals/ff700229.aspx" target="_top">http://technet.microsoft.com/en-us/sysinternals/ff700229.aspx</a>
                    </p></div>
</td></tr></tbody>
</table></div>
</div>
<br class="table-break"><p>
          The eagle eyed amongst you will have noticed that the AFIO implementation
          looks hand tuned with a special depth first algorithm balancing concurrency
          with seek locality -- that's because I invested two days into achieving
          maximum possible performance as a demonstration of AFIO's power (and to
          find and fix some bottlenecks). Some might argue that this is therefore
          not a fair comparison to the OpenMP iostreams implementation.
        </p>
<p>
          There are two parts to answering this argument. The first is that yes,
          the OpenMP iostreams search algorithm is fairly stupid and simply tries
          to read as many files as there are CPUs, and those files could be stored
          anywhere on the spinning disc. Because AFIO can issue far more concurrent
          file open and read requests than OpenMP, it gives a lot more scope to the
          filing system to optimise hard drive seeks and satisfy as many requests
          as is feasible -- sufficiently so that with a cold cache, AFIO is a little
          slower than a single threaded iostreams implementation where the filing
          system can spot the access pattern and prefetch quite effectively. A completely
          valid solution to the OpenMP performance deficit would be to increase thread
          count dramatically.
        </p>
<p>
          The second part of answering that argument is this: AFIO's very flexible
          op chaining structure lets you very easily twiddle with the execution dependency
          graph to achieve maximum possible performance by balancing concurrency
          (too much or too little is slower, what you need is just the right balance)
          and disc seeks (enumerations are best not done in parallel, it defeats
          any prefetching algorithm), unlike the naive OpenMP implementation which
          is much harder to play around with. Don't get me wrong: if you have plenty
          of time on your hands, you can implement a hand written and tuned find
          in files implementation that is faster than AFIO's implementation, but
          it will have taken you a lot longer, and the code will neither be as portable
          nor as maintainable.
        </p>
<div class="footnotes">
<br><hr style="width:100; text-align:left;margin-left: 0">
<div id="ftn.afio.quickstart.async_file_io.so_what.f0" class="footnote"><p><a href="#afio.quickstart.async_file_io.so_what.f0" class="para"><sup class="para">[10] </sup></a>
            Indeed many ask the same when programming WinRT apps -- Microsoft's insistance
            on never allowing any call to block can make simple designs explode with
            complexities of nested callbacks.
          </p></div>
<div id="ftn.afio.quickstart.async_file_io.so_what.f1" class="footnote"><p><a href="#afio.quickstart.async_file_io.so_what.f1" class="para"><sup class="para">[11] </sup></a>
            Test machine was a 3.5Ghz Intel i7-3770K Microsoft Windows 8 x64 machine
            with Seagate ST3320620AS 7200rpm hard drive. Note that AFIO has a native
            WinIOCP backend which leverages host asynchronous file i/o support.
          </p></div>
</div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2013 Niall Douglas and Paul Kirth<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="hello_world.html"><img src="../../../../../doc/src/images/prev.png" alt="Prev"></a><a accesskey="u" href="../async_file_io.html"><img src="../../../../../doc/src/images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../../../doc/src/images/home.png" alt="Home"></a><a accesskey="n" href="../closure_engine.html"><img src="../../../../../doc/src/images/next.png" alt="Next"></a>
</div>
</body>
</html>
